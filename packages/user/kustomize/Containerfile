FROM scratch AS build
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-go . /
COPY --from=stagex/core-ca-certificates . /
ADD fetch/kustomize-${VERSION}.tar.gz .
WORKDIR /kustomize-kustomize-v${VERSION}/kustomize
ENV GOPATH=/cache/go
ENV GOCACHE=/cache/
ENV GOWORK=off
ENV GOPROXY=https://proxy.golang.org,direct
ENV GOSUMDB=sum.golang.org
ENV CGO_ENABLED=0
ENV GOHOSTOS=linux
ENV GOHOSTARCH=amd64
ENV SOURCE_DATE_EPOCH=1
RUN go mod download
ENV GOPROXY=off
RUN --network=none <<-EOF
	set -eu
	go build \
		-v \
		-trimpath \
		-mod=readonly \
		-ldflags " \
			-X sigs.k8s.io/kustomize/api/provenance.version=${VERSION} \
			-X sigs.k8s.io/kustomize/api/provenance.builddate=$(date -u +'%Y-%m-%dT%H:%M:%SZ' --date=@${SOURCE_DATE_EPOCH}) \
		" \
		.
	mkdir -p /rootfs/usr/bin/
	cp kustomize /rootfs/usr/bin/
	install -Dm644 ../LICENSE /usr/share/licenses/kustomize/LICENSE
EOF

FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

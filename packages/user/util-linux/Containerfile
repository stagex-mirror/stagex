FROM stagex/pallet-clang-gnu-busybox AS build
COPY --from=stagex/core-cmake . /
COPY --from=stagex/core-bash . /
COPY --from=stagex/core-ncurses . /
COPY --from=stagex/core-zlib . /
COPY --from=stagex/core-samurai . /
COPY --from=stagex/core-openssl . /
COPY --from=stagex/core-python . /
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-pkgconf . /
COPY --from=stagex/core-meson . /
COPY --from=stagex/core-sqlite3 . /
COPY --from=stagex/core-binutils . /
COPY --from=stagex/core-coreutils . /
COPY --from=stagex/core-libxml2 . /
COPY --from=stagex/user-libcap-ng . /
COPY --from=stagex/user-file . /
ARG VERSION
ADD fetch/util-linux-${VERSION}.tar.gz .
RUN mv /util-linux-* util-linux
WORKDIR /util-linux
ADD patches/cryptsetup-auto.patch .
RUN --network=none <<-EOF
	patch -p1 < cryptsetup-auto.patch
	export PKG_CONFIG_FDO_SYSROOT_FILES=1
	export CFLAGS="-D_DIRENT_HAVE_D_TYPE"
	rm tests/ts/lsns/ioctl_ns
	rm tests/ts/col/multibyte
	meson setup \
		--prefix=/usr \
		--bindir=/usr/bin \
		--sbindir=/usr/sbin \
		--auto-feature=enabled \
		-Dtinfo=disabled \
		-Dncurses=disabled \
		-Deconf=disabled \
		-Dselinux=disabled \
		-Dslang=disabled \
		-Dlibutil=disabled \
		-Dlibuser=disabled \
		-Dlibutempter=disabled \
		-Dreadline=disabled \
		-Dbuild-col=disabled \
		-Dbuild-waitpid=disabled \
		-Dbuild-exch=disabled \
		-Dbuild-plymouth-support=disabled \
		-Dbuild-bash-completion=disabled \
		-Dfs-search-path-extra=/usr/sbin:/usr/bin \
		-Dbuild-agetty=disabled \
		-Dbuild-cal=disabled \
		-Dbuild-fallocate=disabled \
		-Dbuild-kill=disabled \
		-Dbuild-liblastlog2=disabled \
		-Dbuild-logger=disabled \
		-Dbuild-login=disabled \
		-Dbuild-runuser=disabled \
		-Dbuild-mesg=disabled \
		-Dbuild-more=disabled \
		-Dbuild-chfn-chsh=disabled \
		-Dbuild-nologin=disabled \
		-Dbuild-newgrp=disabled \
		-Dbuild-pam-lastlog2=disabled \
		-Dbuild-pivot_root=disabled \
		-Dbuild-setarch=disabled \
		-Dbuild-switch_root=disabled \
		-Dbuild-sulogin=disabled \
		-Dbuild-su=disabled \
		-Dbuild-ul=disabled \
		-Dbuild-vipw=disabled \
		-Dbuild-wall=disabled \
		-Dbuild-write=disabled \
		-Dbuild-python=disabled \
		-Dsystemd=disabled \
		-Dsysvinit=disabled \
		. output
	meson compile -C output
	DESTDIR=/rootfs meson install --no-rebuild -C output
EOF

FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

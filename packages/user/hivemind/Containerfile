FROM stagex/pallet-go AS build
ARG VERSION
ADD fetch/hivemind-${VERSION}.tar.gz .
WORKDIR /hivemind-${VERSION}
COPY *.patch .
RUN go mod download
RUN --network=none <<-EOF
	set -eux
    
    patch -p1 < allow-skipping-dotenv-load.patch
	go build -v -o hivemind
	install -Dm0755 -t /rootfs/usr/bin hivemind
	install -vDm644 -t /rootfs/usr/share/licenses/hivemind LICENSE
EOF

FROM stagex/core-filesystem AS package-hugo
COPY --from=build /rootfs/ /
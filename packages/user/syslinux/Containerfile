# HACK: we get away with gcc here only because this is a bootloader, and standalone
# there are lots of implicit function declarations we will need to work around to 
# build this with LLVM
FROM stagex/pallet-gcc-gnu-busybox AS build
ARG VERSION
COPY --from=stagex/core-perl . /
COPY --from=stagex/user-util-linux . /
ADD fetch/syslinux-${VERSION}.tar.xz .
WORKDIR /syslinux-${VERSION}
COPY patches/*.patch .
RUN --network=none <<-EOF
	set +eux
	patch -p1 < fix-sysmacros.patch
	patch -p1 < prevent-pow-optimization.patch
	patch -p1 < gcc-14.patch
	patch -p1 < gcc-10.patch
	make -j1 bios efi64 installer
	make \
		INSTALLROOT="/rootfs" \
		MANDIR=/usr/share/man \
		BINDIR=/usr/bin \
		SBINDIR=/usr/sbin \
		LIBDIR=/usr/lib \
		install
EOF
FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

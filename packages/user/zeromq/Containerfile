FROM stagex/pallet-clang-cmake-busybox AS build
ARG VERSION
COPY --from=stagex/user-libsodium . /
COPY --from=stagex/user-util-linux . /
COPY --from=stagex/user-xmlto . /
ADD fetch/zeromq-${VERSION}.tar.gz .
WORKDIR /zeromq-${VERSION}
RUN --network=none <<-EOF
	cmake -B build -G Ninja \
		-DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DBUILD_TESTS=OFF \
		-DBUILD_STATIC=OFF \
		-DWITH_LIBSODIUM=ON \
		-DENABLE_CURVE=ON \
		-DWITH_DOC=OFF
	cmake --build build
	cmake -B build-static -G Ninja \
		-DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/rootfs/usr \
		-DBUILD_TESTS=OFF \
		-DBUILD_STATIC=ON \
		-DBUILD_SHARED=OFF \
		-DWITH_LIBSODIUM=ON \
		-DWITH_LIBSODIUM_STATIC=ON \
		-DENABLE_CURVE=ON \
		-DWITH_DOC=OFF
	cmake --build build-static
	DESTDIR="/rootfs/" cmake --install build
	install -Dm644 build-static/lib/*.a -t /rootfs/usr/lib
EOF

# FROM stagex/core-filesystem AS package
FROM scratch AS package
COPY --from=build /rootfs/ /

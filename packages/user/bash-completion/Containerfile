FROM stagex/pallet-clang-gnu-busybox AS build
ARG VERSION
COPY --from=stagex/core-cmake . /
ADD fetch/bash-completion-${VERSION}.tar.gz .
WORKDIR /bash-completion-${VERSION}
ENV CFLAGS="-march=x86-64 -mtune=generic -fno-lto"
ENV CXXFLAGS="-fno-lto"
RUN --network=none <<-EOF
  set -eu
	autoreconf -fi
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc
	make
	make DESTDIR="/rootfs" install
	mkdir -p /rootfs/etc/bash
	mv /rootfs/etc/profile.d/bash_completion.sh /rootfs/etc/bash/
	rm -rf /rootfs/etc/profile.d/
	install -Dm644 -t /rootfs/usr/share/licenses/bash-completion/ COPYING
	mkdir -p /rootfs/usr/lib
	mv /rootfs/usr/share/pkgconfig /rootfs/usr/lib/pkgconfig
EOF

FROM stagex/core-filesystem AS package
COPY --from=build /rootfs /

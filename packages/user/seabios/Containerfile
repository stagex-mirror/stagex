FROM stagex/pallet-clang-gnu-busybox AS build
ARG VERSION
COPY --from=stagex/core-python . /

#HACK: We get away with building this with GCC because this is firmware
# It is neither a binary or library, and standalone. Compiler does not
# actually matter that much in this case anyway
# Of note, Linux kernel had, and fixed, the same problem: https://github.com/llvm/llvm-project/issues/32934
COPY --from=stagex/core-mpfr . /
COPY --from=stagex/core-isl . /
COPY --from=stagex/core-mpc . /
COPY --from=stagex/core-gmp . /
COPY --from=stagex/core-gcc . /

ADD fetch/seabios-${VERSION}.tar.gz .
WORKDIR /seabios-rel-${VERSION}
ADD config.* .
RUN --network=none <<-EOF
	export CC=gcc
	export AS=/usr/bin/as
	mkdir output
	echo "Stagex ${VERSION}" > .version
	printf " \
	coreboot bios.bin.elf bios-coreboot.bin\n \
	csm Csm16.bin bios-csm.bin\n \
	seabios-128k bios.bin bios.bin\n \
	seabios-256k bios.bin bios-256k.bin\n \
	seabios-microvm bios.bin bios-microvm.bin\n \
	vga-ati vgabios.bin vgabios-ati.bin out/vgabios.bin\n \
	vga-bochs-display vgabios.bin vgabios-bochs-display.bin out/vgabios.bin\n \
	vga-cirrus vgabios.bin vgabios-cirrus.bin out/vgabios.bin\n \
	vga-isavga vgabios.bin vgabios-isavga.bin out/vgabios.bin\n \
	vga-qxl vgabios.bin vgabios-qxl.bin out/vgabios.bin\n \
	vga-ramfb vgabios.bin vgabios-ramfb.bin out/vgabios.bin\n \
	vga-stdvga vgabios.bin vgabios-stdvga.bin out/vgabios.bin\n \
	vga-virtio vgabios.bin vgabios-virtio.bin out/vgabios.bin\n \
	vga-vmware vgabios.bin vgabios-vmware.bin out/vgabios.bin" \
	| while IFS= read -r line; do
		set -- $line;
		config_name="$1";
		output_name="$2";
		binary_name="$3";
		build_target="${4:-}";
		make clean distclean;
		cp "config.${config_name}" .config;
		make oldnoconfig V=1;
		make V=1 EXTRAVERSION=-1 PYTHON=python3 $build_target
		cp "out/${output_name}" "output/${binary_name}"
	done
	install -vDm 644 output/*.bin -t /rootfs/usr/share/qemu/
EOF
FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

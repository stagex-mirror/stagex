FROM scratch AS build
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-binutils . /

COPY --from=stagex/core-make . /
COPY --from=stagex/core-musl . /
COPY --from=stagex/core-libxml2 . /
COPY --from=stagex/core-libxslt . /
COPY --from=stagex/core-linux-headers . /
COPY --from=stagex/core-openssl . /
COPY --from=stagex/core-pcre2 . /
COPY --from=stagex/core-perl . /
COPY --from=stagex/core-pkgconf . /

COPY --from=stagex/core-zlib . /
COPY --from=stagex/core-libzstd . /
ADD fetch/nginx-${VERSION}.tar.xz .
WORKDIR /nginx-${VERSION}
RUN --network=none <<-EOF
	set -eux
	export NJS_CFLAGS="-Wno-error=dangling-pointer"
	./configure \
		--prefix=/usr \
		--with-threads \
		--with-file-aio \
		--with-http_ssl_module \
		--with-http_gunzip_module \
		--with-http_gzip_static_module \
		--with-http_auth_request_module \
		--with-http_auth_request_module \
		--with-http_random_index_module \
		--with-http_secure_link_module \
		--with-http_degradation_module \
		--with-http_slice_module \
		--with-http_stub_status_module \
		--with-http_perl_module=dynamic \
		--with-mail=dynamic \
		--with-mail_ssl_module \
		--with-stream=dynamic \
		--with-stream_ssl_module \
		--with-stream_realip_module

	make -j "$(nproc)"
	make DESTDIR=/rootfs install
EOF
FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

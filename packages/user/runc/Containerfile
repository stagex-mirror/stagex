FROM stagex/pallet-cgo AS build
ARG VERSION
COPY --from=stagex/user-libseccomp . /
COPY --from=stagex/user-go-md2man . /
ADD fetch/runc-${VERSION}.tar.gz .
WORKDIR /runc-${VERSION}
COPY --chmod=755 <<-EOF /usr/bin/git
	#!/bin/sh
	echo ${VERSION}
EOF
RUN <<-EOF
	# HACK: build in yolo mode because of some buried error we have not tracked down yet
	set +eux
	make EXTRA_LDFLAGS="-w -s -buildid=" COMMIT=${VERSION} -j "$(nproc)"
	install -Dsm755 runc /rootfs/usr/bin/runc
EOF
FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

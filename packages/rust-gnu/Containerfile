FROM scratch AS base
ARG VERSION=1.81.0
ENV SRC_SITE=https://static.rust-lang.org/dist
ENV SRC_HASH=872448febdff32e50c3c90a7e15f9bb2db131d13c588fe9071b0ed88837ccfa7

FROM base AS fetch
COPY --from=stagex/busybox . /
ADD --checksum=sha256:${SRC_HASH} ${SRC_SITE}/rustc-${VERSION}-src.tar.gz .

FROM fetch AS build
COPY --from=stagex/binutils . /
COPY --from=stagex/bash . /
COPY --from=stagex/make . /
COPY --from=stagex/cmake . /
COPY --from=stagex/python . /
COPY --from=stagex/py-setuptools . /
COPY --from=stagex/zlib . /
COPY --from=stagex/pkgconf . /
COPY --from=stagex/openssl . /
COPY --from=stagex/perl . /
COPY --from=stagex/gcc . /
COPY --from=stagex/libunwind . /
COPY --from=stagex/musl . /
COPY --from=stagex/rust . /
COPY --from=stagex/glibc . /
COPY --from=stagex/curl . /
COPY --from=stagex/ca-certificates . /
COPY --from=stagex/llvm . /

RUN tar -xzf rustc-${VERSION}-src.tar.gz
WORKDIR rustc-${VERSION}-src
ADD *.patch .
RUN <<EOF
	set -eux
	PREFIX=/rust-${VERSION}/usr
    patch -p1 ../glibc.patch
	./configure \
		--build="x86_64-unknown-linux-musl" \
		--host="x86_64-unknown-linux-musl" \
		--target="x86_64-unknown-linux-gnu" \
		--enable-local-rust \
		--llvm-root="/usr" \
		--disable-docs \
		--enable-llvm-link-shared \
		--enable-option-checking \
		--enable-locked-deps \
		--enable-vendor \
		--dist-compression-formats=gz \
		--python="python3" \
		--prefix="/usr" \
		--libdir="/usr/lib/x86_64-linux-gnu" \
		--sysconfdir="/rootfs/etc" \
		--release-channel="stable" \
		--set="install.prefix=/rootfs" \
		--set="build.extended=true" \
		--set="rust.musl-root=/usr" \
		--set="rust.backtrace-on-ice=true" \
		--set="rust.codegen-units=1" \
		--set="rust.codegen-units-std=1" \
		--set="rust.deny-warnings=false" \
		--set="rust.parallel-compiler=false" \
		--set="rust.remap-debuginfo=true" \
		--set="rust.llvm-libunwind=system" \
		--set="build.full-bootstrap=true" \
		--set="target.x86_64-unknown-linux-gnu.llvm-config=/usr/bin/llvm-config" \
		--set="target.x86_64-unknown-linux-gnu.cc=cc" \
		--set="target.x86_64-unknown-linux-gnu.cxx=c++" \
		--set="target.x86_64-unknown-linux-gnu.ar=ar" \
		--set="target.x86_64-unknown-linux-gnu.linker=cc" \
		--set="target.x86_64-unknown-linux-gnu.musl-libdir=/usr/lib/x86_64-linux-gnu"
	rm /lib64
	mv /usr/lib64-pre-move /lib64
	python3 x.py build --stage 0 --target x86_64-unknown-linux-gnu library
EOF

FROM build AS install
RUN <<-EOF
	mkdir -p /rootfs/usr/lib/rustlib/
	cp -r \
        /rustc-${VERSION}-src/build/x86_64-unknown-linux-musl/stage0-sysroot/lib64/rustlib/x86_64-unknown-linux-gnu \
        /rootfs/usr/lib/rustlib/
EOF

FROM stagex/filesystem AS package
COPY --from=install /rootfs/. /

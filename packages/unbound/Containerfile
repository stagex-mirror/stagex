FROM scratch AS base
ARG ARCH=x86_64
ENV VERSION=1.21.0
ENV SRC_HASH=e7dca7d6b0f81bdfa6fa64ebf1053b5a999a5ae9278a87ef182425067ea14521
ENV SRC_FILE=unbound-${VERSION}.tar.gz
ENV SRC_SITE=https://unbound.net/downloads/${SRC_FILE}

FROM base AS fetch
ADD --checksum=sha256:${SRC_HASH} ${SRC_SITE} .

FROM fetch AS build
COPY --from=stagex/busybox . /
COPY --from=stagex/binutils . /
COPY --from=stagex/python . /
COPY --from=stagex/musl . /
COPY --from=stagex/gcc . /
COPY --from=stagex/make . /
COPY --from=stagex/libevent . /
COPY --from=stagex/linux-headers . /
COPY --from=stagex/nghttp2 . /
COPY --from=stagex/openssl . /
COPY --from=stagex/pkgconf . /
COPY --from=stagex/protobuf . /
COPY --from=stagex/protobuf-c . /
COPY --from=stagex/expat . /
COPY --from=stagex/python . /
COPY --from=stagex/abseil-cpp . /
COPY --from=stagex/zlib . /
COPY --from=stagex/swig . /
RUN tar -xf ${SRC_FILE}
WORKDIR /unbound-${VERSION}
COPY *.patch .
RUN --network=none <<-EOF
	set -ex
	patch -p1 conf.patch
    CFLAGS="-flto=auto"

	PYTHON_VERSION=3 ./configure \
		--build=${ARCH}-linux-musl \
		--host=${ARCH}-linux-musl \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-pie \
		--enable-relro-now \
		--with-username=unbound \
		--with-run-dir="" \
		--with-pidfile="" \
		--with-rootkey-file=/usr/share/dnssec-root/trusted-key.key \
		--with-libevent \
		--with-pthreads \
		--disable-static \
		--disable-rpath \
		--disable-dsa \
		--disable-gost \
		--enable-dnstap \
		--enable-subnet \
		--with-ssl \
		--without-pythonmodule \
		--with-pyunbound \
        --with-libnghttp2

	# do not link to libpython
	sed -i -e '/^LIBS=/s/-lpython.*[[:space:]]/ /' Makefile

	make
EOF

FROM build AS install
RUN --network=none <<-EOF
    DESTDIR=/rootfs
    make DESTDIR=${DESTDIR} install
	make DESTDIR=${DESTDIR} unbound-event-install

	install -Dm755 contrib/update-anchor.sh \
		${DESTDIR}/usr/share/unbound/update-anchor.sh

	install -D -m644 doc/CREDITS doc/Changelog doc/FEATURES \
		doc/README doc/TODO -t ${DESTDIR}/usr/share/doc/unbound/

	cd ${DESTDIR}

	install -Dm755 ${DESTDIR}/unbound.initd ./etc/init.d/unbound
	install -Dm644 ${DESTDIR}/unbound.confd ./etc/conf.d/unbound
	install -d -m755 ${DESTDIR}/etc/unbound/unbound.conf.d
EOF

FROM stagex/filesystem AS package
COPY --from=install /rootfs/. /

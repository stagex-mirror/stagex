FROM scratch AS base
ENV VERSION=3.0.0-beta.1
ENV SRC_HASH=c7168df8d5ad015455892a83e2fec81ed129d27e7aaef800e486629872cc139b
ENV SRC_FILE=
ENV SRC_SITE=

FROM base AS fetch

FROM fetch AS build
COPY --from=stagex/zlib . /
COPY --from=stagex/go . /
COPY --from=stagex/curl . /
COPY --from=stagex/git . /
COPY --from=stagex/busybox . /
COPY --from=stagex/binutils . /
COPY --from=stagex/make . /
COPY --from=stagex/musl . /
COPY --from=stagex/gcc . /
COPY --from=stagex/openssl . /
COPY --from=stagex/ca-certificates . /
RUN git clone https://github.com/distribution/distribution.git
WORKDIR /distribution
RUN git checkout c709432b917488208fa78a7932843d91eca59801
RUN git archive --format=tar.gz --output=../distribution-${VERSION}.tar.gz HEAD
RUN sha256sum ../distribution-${VERSION}.tar.gz | awk '{print $1}' > checksum.txt && echo "SHA256: $(cat checksum.txt)"
RUN echo "${SRC_HASH} ../distribution-${VERSION}.tar.gz" | sha256sum -c
RUN --network=none <<-EOF
    set -eux
    make binaries -j "$(nproc)"
EOF

FROM build AS install
RUN <<-EOF
    mkdir -p /rootfs/usr/bin/
    cp -R bin/ /rootfs/usr/bin/
EOF

FROM stagex/filesystem AS package
COPY --from=install /rootfs/. /


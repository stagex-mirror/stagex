FROM scratch AS build
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-musl . /
COPY --from=stagex/core-gcc . /
COPY --from=stagex/core-binutils . /
COPY --from=stagex/core-ncurses . /
COPY --from=stagex/core-readline . /
COPY --from=stagex/core-make . /
ADD fetch/lua-${VERSION}.tar.gz .
WORKDIR /lua-${VERSION}
COPY *.patch .
RUN --network=none <<-EOF
	set -eux

	patch -p1 -i liblua.so.patch
EOF

RUN --network=none <<-EOF
	set -eux

	VERSION_MAJOR=5.4

	make \
		-j "$(nproc)" \
		MYCFLAGS="-fPIC" \
		MYLIBS=-lncursesw \
		linux-readline

	make \
		TO_LIB="liblua.so liblua.so.${VERSION_MAJOR} liblua.so.${VERSION}" \
		INSTALL_DATA="cp -d" \
		INSTALL_TOP="/rootfs/usr" \
		install
	ln -sf /usr/bin/lua /rootfs/usr/bin/lua${VERSION_MAJOR}
	ln -sf /usr/bin/luac /rootfs/usr/bin/luac${VERSION_MAJOR}
EOF

FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

FROM scratch AS build
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-gcc . /
COPY --from=stagex/core-make . /
COPY --from=stagex/core-musl . /
COPY --from=stagex/core-binutils . /
COPY --from=stagex/core-autoconf . /
COPY --from=stagex/core-automake . /
COPY --from=stagex/core-libtool . /
ADD fetch/libunwind-${VERSION}.tar.gz .
WORKDIR /libunwind-${VERSION}
RUN --network=none <<-EOF
	set -eux
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/usr/share/man \
		--enable-cxx-exceptions \
		--disable-tests \
		--infodir=/usr/share/info || (cat config.log; exit 1)
	make -j "$(nproc)"
	make DESTDIR=/rootfs install
EOF

FROM scratch AS build-glibc
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-gcc . /
COPY --from=stagex/core-cross-x86_64-gnu-gcc . /
COPY --from=stagex/core-make . /
COPY --from=stagex/core-musl . /
COPY --from=stagex/core-binutils . /
COPY --from=stagex/core-autoconf . /
COPY --from=stagex/core-automake . /
COPY --from=stagex/core-libtool . /
ADD fetch/libunwind-${VERSION}.tar.gz .
WORKDIR /libunwind-${VERSION}
RUN --network=none <<-EOF
	set -eux
	ARCH=$(uname -m)
	ls -la /opt/cross/x86_64-linux-gnu/include
	CC=/opt/cross/bin/x86_64-linux-gnu-gcc \
	CFLAGS="-Wp,-nostdinc -isystem /opt/cross/x86_64-linux-gnu/include -isystem /opt/cross/lib/gcc/x86_64-linux-gnu/13.1.0/include" \
	./configure \
		--build=x86_64-linux-musl \
		--host=x86_64-linux-gnu \
		--prefix=/opt/cross/usr \
		--includedir=/opt/cross/${ARCH}-linux-gnu/include \
		--libdir=/opt/cross/${ARCH}-linux-gnu/lib \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/usr/share/man \
		--enable-cxx-exceptions \
		--disable-tests \
		--infodir=/usr/share/info || (cat config.log; exit 1)
	make -j "$(nproc)"
	make DESTDIR=/rootfs install
EOF

FROM stagex/core-filesystem AS package-libunwind
COPY --from=build /rootfs/ /

FROM stagex/core-filesystem AS package-cross-x86_64-gnu-libunwind
COPY --from=build-glibc /rootfs/ /

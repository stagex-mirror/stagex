FROM scratch AS build-libunwind
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-gcc . /
COPY --from=stagex/core-make . /
COPY --from=stagex/core-musl . /
COPY --from=stagex/core-binutils . /
COPY --from=stagex/core-autoconf . /
COPY --from=stagex/core-automake . /
COPY --from=stagex/core-libtool . /
ADD fetch/libunwind-${VERSION}.tar.gz .
WORKDIR /libunwind-${VERSION}
RUN --network=none <<-EOF
	set -eux
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/usr/share/man \
		--enable-cxx-exceptions \
		--disable-tests \
		--infodir=/usr/share/info || cat config.log
	make -j "$(nproc)"
	make DESTDIR=/rootfs install
EOF
FROM stagex/core-filesystem AS package-libunwind
COPY --from=build-libunwind /rootfs/ /

FROM scratch AS build-cross-x86_64-gnu-libunwind
ARG VERSION
COPY --from=stagex/core-busybox . /
COPY --from=stagex/core-cross-x86_64-gnu-gcc . /
COPY --from=stagex/core-gcc . /
COPY --from=stagex/core-make . /
COPY --from=stagex/core-musl . /
COPY --from=stagex/core-binutils . /
COPY --from=stagex/core-autoconf . /
COPY --from=stagex/core-automake . /
COPY --from=stagex/core-libtool . /
ADD fetch/libunwind-${VERSION}.tar.gz .
WORKDIR /libunwind-${VERSION}
RUN --network=none <<-EOF
	set -eux
	CC=/opt/cross/bin/x86_64-linux-gnu-gcc \
	CPP='/opt/cross/bin/x86_64-linux-gnu-gcc -E' \
	CPPFLAGS='-nostdinc -isystem /opt/cross/x86_64-linux-gnu/include' \
	./configure \
		--build=x86_64-linux-musl \
		--host=x86_64-linux-gnu \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/usr/share/man \
		--enable-cxx-exceptions \
		--disable-tests \
		--infodir=/usr/share/info || (cat config.log; exit 1)
	make -j "$(nproc)" || (cat config.log; exit 1)
	make DESTDIR=/rootfs install
EOF
FROM stagex/core-filesystem AS package-cross-x86_64-gnu-libunwind
COPY --from=build-cross-x86_64-gnu-libunwind /rootfs/ /

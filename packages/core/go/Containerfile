FROM scratch AS build
ARG VERSION
COPY --from=stagex/bootstrap-stage3 . /
COPY --from=fetch . .
RUN <<-EOF
	set -eux
	tar -xzf go${VERSION}.src.tar.gz
EOF
WORKDIR /go
ENV GOROOT_BOOTSTRAP=/usr/lib/go
RUN --network=none <<-EOF
	set -eux
	cd src
	sh make.bash
	cd ..
	mkdir -p /rootfs/usr/lib/go
	cp -a bin lib pkg src /rootfs/usr/lib/go
	mkdir -p /rootfs/usr/bin
	ln -s /usr/lib/go/bin/go /rootfs/usr/bin/go
	ln -s /usr/lib/go/bin/gofmt /rootfs/usr/bin/gofmt
EOF
FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

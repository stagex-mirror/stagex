FROM scratch AS build
ARG VERSION
COPY --from=stagex/bootstrap-stage3 . /
#COPY --from=stagex/core-samurai . /
#COPY --from=stagex/core-busybox . /
#COPY --from=stagex/core-binutils . /
#COPY --from=stagex/core-musl . /
#COPY --from=stagex/core-make . /
#COPY --from=stagex/core-linux-headers . /
#COPY --from=stagex/core-gcc . /
#COPY --from=stagex/core-zlib . /
#COPY --from=stagex/core-openssl . /
ADD fetch/cmake-${VERSION}.tar.gz .
WORKDIR /cmake-${VERSION}
ENV LD_LIBRARY_PATH=/usr/lib:/lib
ENV CFLAGS="-L/usr/lib -L/usr/lib64 -L/lib"
ENV CXXFLAGS="$CFLAGS"
ENV CC=gcc
ENV CXX=gcc
RUN --network=none <<-EOF
	set -eux
	./configure \
		--prefix=/usr \
		--mandir=/share/man \
		--datadir=/share/cmake \
		--docdir=/share/doc/cmake \
		--no-system-cppdap \
		--no-system-curl \
		--no-system-jsoncpp \
		-- \
		-DCMAKE_USE_OPENSSL=off \
		|| cat /cmake-3.31.5/Bootstrap.cmk/cmake_bootstrap.log
	make -j "$(nproc)"
	make DESTDIR=/rootfs install
EOF
FROM stagex/core-filesystem AS package
COPY --from=build /rootfs/ /

FROM scratch AS base
ENV VERSION=37f63fd63ac58ba338719395977054d9d3202325
ENV SRC_HASH=ba59a3090f0ad9fe051197f1f4b77d70dcb92eceaa3dff80133887e46b271cf8
ENV SRC_FILE=${VERSION}.tar.gz
ENV SRC_SITE=https://git.distrust.co/public/keyfork/archive/${SRC_FILE}

FROM base AS fetch
ADD --checksum=sha256:${SRC_HASH} ${SRC_SITE} .
COPY --from=stagex/rust . /
COPY --from=stagex/busybox . /
COPY --from=stagex/musl . /
COPY --from=stagex/gcc . /
COPY --from=stagex/llvm . /
COPY --from=stagex/libunwind . /
COPY --from=stagex/openssl . /
COPY --from=stagex/zlib . /
COPY --from=stagex/ca-certificates . /
RUN tar xf ${SRC_FILE}
WORKDIR keyfork
ADD <<-EOF /.cargo/config.toml
	[registries.distrust]
	index = "https://git.distrust.co/public/_cargo-index.git"
	EOF
RUN cargo fetch

FROM fetch AS build
COPY --from=stagex/clang . /
COPY --from=stagex/linux-headers . /
COPY --from=stagex/gmp . /
COPY --from=stagex/nettle . /
COPY --from=stagex/pcsc-lite . /
COPY --from=stagex/pkgconf . /
COPY --from=stagex/binutils . /
ENV RUST_BACKTRACE=1
ENV NETTLE_STATIC=yes
ENV PCSC_LIB_NAME=static=pcsclite
ENV RUSTFLAGS='-C codegen-units=1'
RUN --network=none \
    cargo build \
        --frozen \
        --release \
        --features static \
        --target x86_64-unknown-linux-musl \
        --bin keyfork

FROM scratch AS install
COPY --from=build keyfork/target/release/keyfork /rootfs/usr/bin/keyfork
RUN find /rootfs -exec touch -hcd "@0" "{}" +

FROM scratch AS package
COPY --from=install /rootfs/. /

FROM scratch AS base
ARG VERSION=1.82.0
ENV SRC_SITE=https://static.rust-lang.org/dist
ENV SRC_HASH=7c53f4509eda184e174efa6ba7d5eeb586585686ce8edefc781a2b11a7cf512a

FROM base AS fetch
COPY --from=stagex/busybox . /
ADD --checksum=sha256:${SRC_HASH} ${SRC_SITE}/rustc-${VERSION}-src.tar.gz .

FROM fetch AS build
COPY --from=stagex/binutils . /
COPY --from=stagex/bash . /
COPY --from=stagex/make . /
COPY --from=stagex/cmake . /
COPY --from=stagex/python . /
COPY --from=stagex/py-setuptools . /
COPY --from=stagex/zlib . /
COPY --from=stagex/pkgconf . /
COPY --from=stagex/openssl . /
COPY --from=stagex/perl . /
COPY --from=stagex/gcc . /
COPY --from=stagex/libunwind . /
COPY --from=stagex/musl . /
COPY --from=stagex/rust . /
COPY --from=stagex/curl . /
COPY --from=stagex/ca-certificates . /
COPY --from=stagex/llvm . /
COPY --from=stagex/cross-x86_64-gnu . /

RUN tar -xzf rustc-${VERSION}-src.tar.gz
WORKDIR rustc-${VERSION}-src
ADD *.patch .
RUN <<EOF
	set -eux
	PREFIX=/rust-${VERSION}/usr
	./configure \
		--build="x86_64-unknown-linux-musl" \
		--host="x86_64-unknown-linux-musl" \
		--target="x86_64-unknown-linux-gnu" \
		--enable-local-rust \
		--llvm-root="/usr" \
		--disable-docs \
		--enable-llvm-link-shared \
		--enable-option-checking \
		--enable-locked-deps \
		--enable-vendor \
		--dist-compression-formats=gz \
		--release-channel="stable" \
		--python="python3" \
		--prefix="/usr" \
		--sysconfdir="/rootfs/etc" \
		--libdir="/opt/cross/lib/x86_64-linux-gnu" \
	    --set="install.prefix=/rootfs" \
		--set="target.x86_64-unknown-linux-gnu.llvm-config=/usr/bin/llvm-config" \
		--set="target.x86_64-unknown-linux-gnu.cc=x86_64-linux-gnu-gcc" \
		--set="target.x86_64-unknown-linux-gnu.cxx=x86_64-linux-gnu-c++" \
		--set="target.x86_64-unknown-linux-gnu.ar=x86_64-linux-gnu-ar" \
		--set="target.x86_64-unknown-linux-gnu.linker=x86_64-linux-gnu-gcc" \
		--set="build.extended=true" \
		--set="rust.backtrace-on-ice=true" \
		--set="rust.codegen-units=1" \
		--set="rust.codegen-units-std=1" \
		--set="rust.deny-warnings=false" \
		--set="rust.parallel-compiler=false" \
		--set="rust.remap-debuginfo=true" \
		--set="rust.llvm-libunwind=in-tree" \
		--set="build.full-bootstrap=true"
	python3 x.py build --stage 0 --target x86_64-unknown-linux-gnu library
EOF

FROM build AS install
RUN <<-EOF
	mkdir -p /rootfs/usr/lib/rustlib/
	cp -r \
        /rustc-${VERSION}-src/build/x86_64-unknown-linux-musl/stage0-sysroot/lib64/rustlib/x86_64-unknown-linux-gnu \
        /rootfs/usr/lib/rustlib/
EOF

FROM stagex/filesystem AS package
COPY --from=install /rootfs/. /
